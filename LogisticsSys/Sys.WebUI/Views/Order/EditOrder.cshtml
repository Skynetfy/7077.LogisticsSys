@using Sys.Entities
@{
    Layout = null;
}
<h4 id="breadcrumbs" class="page-header">修改订单</h4>
<div id="alert-infor1" class="alert alert-success alert-dismissible" role="alert" style="display: none;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <strong>错误!</strong>
    <label></label>
</div>
<form class="form-horizontal form-label-left" id="orderinfform" method="post" action="@Url.Action("EditOrder")" data-parsley-validate data-parsley-excluded="input[type=button],input[type=submit],input[type=reset],input[type=hidden],input[type=radio]">
    <h5 class="h5"><i class="glyphicon glyphicon-paperclip"></i> 主订单信息</h5>
    @{
        var orderinfo = ViewData["OrderInfo"] as SysOrderInfo;
        var addressinfo = ViewData["AddressInfo"] as SysAddresserInfo;
    }
    <input type="hidden" name="orderId" value="@orderinfo.Id" />
    <table class="table">
        <tbody>
            <tr>
                <td style="width:30%">订单号：</td>
                <td>@orderinfo.OrderNo</td>
            </tr>
            <tr>
                <td>下单人姓名：</td>
                <td>@orderinfo.ShipperName</td>
            </tr>
            <tr>
                <td>下单人电话：</td>
                <td>@orderinfo.ShipperPhone</td>
            </tr>
            <tr>
                <td>订单状态：</td>
                <td id="orderstatus">@orderinfo.Status</td>
            </tr>
            <tr>
                <td>下单时间：</td>
                <td>@orderinfo.CreateDate</td>
            </tr>
        </tbody>
    </table>
    <h5 class="h5"><i class="glyphicon glyphicon-paperclip"></i> 寄件人信息</h5>
    <table class="table">
        <tbody>
            <tr>
                <td style="width:30%">俄罗斯城市：</td>
                <td>@addressinfo.CityName</td>
            </tr>
            <tr>
                <td>俄罗斯详细地址：</td>
                <td>@addressinfo.RussiaAddress</td>
            </tr>
            <tr>
                <td>货物箱数：</td>
                <td>@addressinfo.CargoNumber</td>
            </tr>
            <tr>
                <td>取货时间：</td>
                <td>@addressinfo.PickupDate</td>
            </tr>
            <tr>
                <td>取货方式：</td>
                <td id="pickway">@addressinfo.PickupWay</td>
            </tr>
            <tr>
                <td>货物类型：</td>
                <td>@addressinfo.GoodsTypeName</td>
            </tr>
            <tr>
                <td>货物运输类型：</td>
                <td id="transway">@addressinfo.TransportationWay</td>
            </tr>
            <tr>
                <td>保价价值(元)：</td>
                <td>@addressinfo.ProtectPrice</td>
            </tr>
            <tr>
                <td>保单费用(元)：</td>
                <td>@addressinfo.PolicyFee</td>
            </tr>
            <tr>
                <td>货物重量(kg) ：</td>
                <td>@addressinfo.GoodsWeight</td>
            </tr>
            <tr>
                <td>预算价格(元)：</td>
                <td>@addressinfo.BudgetPrice</td>
            </tr>
            <tr>
                <td>箱子外包装总体积：</td>
                <td>长(cm)：@addressinfo.BoxLong  宽(cm)：@addressinfo.BoxWidth   高(cm)：@addressinfo.BoxHeight</td>
            </tr>
            <tr>
                <td><font color="#c7254e">实际体积(cm)：<span class="required">*</span></font></td>
                <td><input name="astj" type="text" required="" data-parsley-type="number" data-parsley-min="1" class="form-control" value="@addressinfo.GoodsVolumeWeight" style="width: 100px;" /></td>
            </tr>
            <tr>
                <td><font color="#c7254e">实际重量(kg)：<span class="required">*</span></font></td>
                <td><input name="agrw" type="text" required="" data-parsley-type="number" data-parsley-min="1" class="form-control" value="@addressinfo.GoodsRealWeight" style="width: 100px;" /></td>
            </tr>
            <tr>
                <td><font color="#c7254e">实际价格(元)：<span class="required">*</span></font></td>
                <td><input name="arp" type="text" class="form-control" required="" data-parsley-type="number" data-parsley-min="1" value="@addressinfo.AddressRealPrice" style="width: 100px;" /></td>
            </tr>

        </tbody>
    </table>
</form>
<h5 class="h5"><i class="glyphicon glyphicon-paperclip"></i> 收件信息</h5>
<table id="datatablelist"
       data-toggle="table"
       data-url="@Url.Action("GetRevicerInfos")"
       data-side-pagination="server"
       data-show-columns="true"
       data-query-params="queryParams">
    <thead>
        <tr>
            <th data-field="ParcelSingle">编号</th>
            <th data-field="CityName">省份</th>
            <th data-field="ChinaAddress" data-visible="false">地址</th>
            <th data-field="ReceiverName">姓名</th>
            <th data-field="ReceiverPhone" data-visible="false">电话</th>
            <th data-field="PackagingWay" data-formatter="PackagingWayFormatter">打包方式</th>
            <th data-field="ExpressWay" data-formatter="ExpressWayFormatter">快递方式</th>
            <th data-field="GoodsDesc" data-visible="false">明细</th>
            <th data-field="ChinaCourierNumber">快递单号</th>
            <th data-field="ParcelWeight">重量</th>
            <th data-field="RealWeight">实际重量</th>
            <th data-field="BudgetPrice">预算价格</th>
            <th data-field="RealPrice">实际价格</th>
            <th data-field="Desc" data-visible="false">备注</th>
            <th data-formatter="ActionFormatter">操作</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<hr />
<div class="row" style="text-align: center;">
    <button class="btn btn-primary" type="button" id="ordersavebtn">处理完成</button>
</div>

<div class="modal fade" id="editModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">收件信息修改</h4>
            </div>
            <div class="modal-body">
                <div id="alert-infor" class="alert alert-success alert-dismissible" role="alert" style="display: none;">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <strong>错误!</strong>
                    <label></label>
                </div>
                <form class="form-horizontal form-label-left" id="shoujianform" method="post" action="@Url.Action("EiditRevecierInfo")" data-parsley-validate data-parsley-excluded="input[type=button],input[type=submit],input[type=reset],input[type=hidden],input[type=radio]">
                    <input type="hidden" name="shoujianId" id="shoujianId" />
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="realweight">
                            实际重量(kg) <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input type="text" id="realweight" name="realweight" required="required" data-parsley-type="number" class="form-control col-md-7 col-xs-12">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="realprice">
                            实际价格(元) <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input type="text" id="realprice" name="realprice" required="required" data-parsley-type="number" class="form-control col-md-7 col-xs-12">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                            <button type="button" class="btn btn-success" id="btn-save-shoukuan">确认修改</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<script src="~/Scripts/parsley.min.js"></script>
<script src="~/Scripts/jquery.form.js"></script>
<script>
    var $table = $('#datatablelist');
    function queryParams(params) {
        params["oid"] = @orderinfo.Id;
        return params;
    }
    function ActionFormatter(value, row, index) {
        var h = [];
        h.push('<button  type="button" class="btn btn-warning btn-xs"  data-toggle="modal" data-target="#editModel" onclick="editClick(' +
            JSON.stringify(row).replace(/\"/g, "\'") +
            ')">修改</button>');
        return h.join('');
    }

    function PackagingWayFormatter(value, row, index) {
        return Status_7077.getPackagingType(row.PackagingWay);
    }

    function ExpressWayFormatter(value, row, index) {
        return Status_7077.getExpressWay(row.ExpressWay);
    }

    function editClick(row) {
        $('#shoujianId').val(row.Id);
        $('#realweight').val(row.RealWeight);
        $('#realprice').val(row.RealPrice);
    }

    $(function() {
        $('[data-toggle="table"]').bootstrapTable();
        $('#orderstatus').html(Status_7077.getOrderStatus(@orderinfo.Status));
        $('#pickway').html(Status_7077.getPickupWay(@addressinfo.PickupWay));
        $('#transway').html(Status_7077.getCargoTransWay(@addressinfo.TransportationWay));

        $('#btn-save-shoukuan').click(function() {
            if ($('#shoujianform').parsley().validate() && $('#shoujianform').parsley().isValid()) {
                $('#shoujianform')
                    .ajaxSubmit({
                        resetForm: true,
                        error: function (xhr, status, error, $form) {
                            $('#alert-infor').removeClass('alert-success');
                            $('#alert-infor').addClass('alert-danger');
                            $('#alert-infor').show();
                            $('#alert-infor label').html(error);
                            $('#alert-infor strong').html('错误！');
                        },
                        success: function (responseText, statusText) {
                            //$('#alert-infor').removeClass('alert-danger');
                            //$('#alert-infor').addClass('alert-success');
                            //$('#alert-infor').show();
                            ////$('#alert-infor label').html(error);
                            //$('#alert-infor strong').html('Successfully');
                            $table.bootstrapTable('refresh');
                            $('#editModel').modal('hide');
                        }
                    });
            }
        });
        $('#ordersavebtn').click(function() {
            if ($('#orderinfform').parsley().validate() && $('#orderinfform').parsley().isValid()) {
                $('body').mLoading("show"); //显示loading组件
                $('#orderinfform')
                    .ajaxSubmit({
                        resetForm: true,
                        error: function (xhr, status, error, $form) {
                            $('#alert-infor1').removeClass('alert-success');
                            $('#alert-infor1').addClass('alert-danger');
                            $('#alert-infor1').show();
                            $('#alert-infor1 label').html(error);
                            $('#alert-infor1 strong').html('错误！');
                        },
                        success: function (responseText, statusText) {
                            $('#main-page').load('@Url.Action("OrderManage")',function (e) {
                                $('body').mLoading("hide"); //显示loading组件
                            });

                        }
                    });
            }
        });
    });

</script>
